# Reusable workflow for triggering a Bitbucket custom pipeline (e.g., contract-test, e2e-bootstrap)
#
# Usage:
#   uses: <owner>/mirror-workflows/.github/workflows/reusable-trigger-custom-pipeline.yml@main
#
# Example caller:
#   on:
#     workflow_dispatch:
#       inputs:
#         pipeline_name:
#           description: 'Pipeline to trigger'
#           required: true
#           type: choice
#           options:
#             - contract-test
#             - e2e-bootstrap
#   jobs:
#     trigger:
#       uses: <owner>/mirror-workflows/.github/workflows/reusable-trigger-custom-pipeline.yml@main
#       with:
#         pipeline_name: ${{ github.event.inputs.pipeline_name }}
#         branch_name: main
#         bitbucket_repo: "workspace/repo-slug"
#         wait_for_pipeline: true
#       secrets:
#         BITBUCKET_API_TOKEN: ${{ secrets.BITBUCKET_API_TOKEN }}

name: Reusable Trigger Bitbucket Custom Pipeline

on:
  workflow_call:
    inputs:
      pipeline_name:
        description: 'Custom pipeline name as defined under pipelines.custom in bitbucket-pipelines.yml'
        required: true
        type: string
      branch_name:
        description: 'Branch to target for the pipeline (defaults to main)'
        required: false
        type: string
        default: 'main'
      bitbucket_repo:
        description: 'Bitbucket repository in workspace/repo-slug format'
        required: true
        type: string
      wait_for_pipeline:
        description: 'If true, poll Bitbucket until the pipeline finishes'
        required: false
        type: boolean
        default: true
      poll_interval:
        description: 'Seconds between polling attempts when waiting'
        required: false
        type: number
        default: 30
      max_attempts:
        description: 'Maximum polling attempts before timing out'
        required: false
        type: number
        default: 60
    secrets:
      BITBUCKET_API_TOKEN:
        description: 'Bitbucket API token/app password with pipeline trigger permission'
        required: true
    outputs:
      pipeline_uuid:
        description: 'UUID of the triggered pipeline'
        value: ${{ jobs.trigger.outputs.pipeline_uuid }}
      pipeline_url:
        description: 'URL for the triggered pipeline'
        value: ${{ jobs.trigger.outputs.pipeline_url }}
      pipeline_result:
        description: 'Final pipeline result when wait_for_pipeline=true'
        value: ${{ jobs.trigger.outputs.pipeline_result }}

jobs:
  trigger:
    runs-on: ubuntu-latest
    outputs:
      pipeline_uuid: ${{ steps.wait-pipeline.outputs.pipeline_uuid || steps.trigger.outputs.triggered_pipeline_uuid }}
      pipeline_url: ${{ steps.wait-pipeline.outputs.pipeline_url || steps.trigger.outputs.pipeline_url }}
      pipeline_result: ${{ steps.wait-pipeline.outputs.pipeline_result }}

    steps:
      - name: Trigger Bitbucket custom pipeline
        id: trigger
        uses: ./.github/actions/trigger-custom-pipeline
        with:
          bitbucket_api_token: ${{ secrets.BITBUCKET_API_TOKEN }}
          bitbucket_repo: ${{ inputs.bitbucket_repo }}
          pipeline_name: ${{ inputs.pipeline_name }}
          branch_name: ${{ inputs.branch_name }}

      # Get the branch HEAD commit from Bitbucket to wait for the correct pipeline
      # This ensures we wait for the pipeline running on the branch's current commit,
      # not the workflow run's commit SHA
      - name: Get Bitbucket branch HEAD commit
        if: inputs.wait_for_pipeline
        id: get-commit
        env:
          BITBUCKET_API_TOKEN: ${{ secrets.BITBUCKET_API_TOKEN }}
          BITBUCKET_REPO: ${{ inputs.bitbucket_repo }}
          BRANCH_NAME: ${{ inputs.branch_name }}
        run: |
          WORKSPACE=$(echo "$BITBUCKET_REPO" | cut -d'/' -f1)
          REPO_SLUG=$(echo "$BITBUCKET_REPO" | cut -d'/' -f2)
          
          # Fetch branch information from Bitbucket API
          RESPONSE=$(curl -s \
            "https://api.bitbucket.org/2.0/repositories/${WORKSPACE}/${REPO_SLUG}/refs/branches/${BRANCH_NAME}" \
            -H "Authorization: Bearer ${BITBUCKET_API_TOKEN}" \
            -H "Accept: application/json")
          
          COMMIT_SHA=$(echo "$RESPONSE" | jq -r '.target.hash // empty' 2>/dev/null)
          
          if [ -z "$COMMIT_SHA" ] || [ "$COMMIT_SHA" = "null" ]; then
            echo "⚠️ Could not fetch branch HEAD from Bitbucket, using workflow commit SHA"
            echo "commit_sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "✅ Found branch HEAD commit: ${COMMIT_SHA}"
            echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          fi

      - name: Wait for Bitbucket pipeline
        if: inputs.wait_for_pipeline
        id: wait-pipeline
        uses: ./.github/actions/wait-for-bitbucket-pipeline
        with:
          bitbucket_api_token: ${{ secrets.BITBUCKET_API_TOKEN }}
          commit_sha: ${{ steps.get-commit.outputs.commit_sha }}
          poll_interval: ${{ inputs.poll_interval }}
          max_attempts: ${{ inputs.max_attempts }}
          expected_pipeline_uuid: ${{ steps.trigger.outputs.triggered_pipeline_uuid }}

      - name: Summarize Bitbucket pipeline result
        if: always()
        env:
          PIPELINE_URL: ${{ steps.wait-pipeline.outputs.pipeline_url || steps.trigger.outputs.pipeline_url }}
          PIPELINE_RESULT: ${{ steps.wait-pipeline.outputs.pipeline_result }}
        run: |
          echo "=== Bitbucket Pipeline Summary ==="
          if [ -n "$PIPELINE_URL" ]; then
            echo "Pipeline URL: $PIPELINE_URL"
          else
            echo "Pipeline URL: (not available)"
          fi
          if [ -n "$PIPELINE_RESULT" ]; then
            echo "Result: $PIPELINE_RESULT"
          else
            echo "Result: (not collected, wait_for_pipeline was false)"
          fi

