# Test workflow for the trigger-custom-pipeline action
#
# This workflow tests the TypeScript actions in isolation by:
# 1. Triggering a custom Bitbucket pipeline
# 2. Optionally waiting for it to complete
#
# To run this test:
#   1. Go to Actions tab in GitHub
#   2. Select "Test: Trigger Custom Pipeline"
#   3. Click "Run workflow"
#   4. Choose your test parameters
#
# Prerequisites:
#   - Repository secret: BITBUCKET_API_TOKEN
#   - Repository variable: BITBUCKET_REPO (workspace/repo-slug format)

name: "Test: Trigger Custom Pipeline"

on:
  workflow_dispatch:
    inputs:
      pipeline_name:
        description: 'Custom pipeline to trigger'
        required: true
        type: choice
        default: 'contract-test'
        options:
          - contract-test
          - e2e-bootstrap
      branch_name:
        description: 'Branch to target'
        required: false
        default: 'main'
      wait_for_pipeline:
        description: 'Wait for pipeline completion?'
        required: false
        type: boolean
        default: true
      poll_interval:
        description: 'Poll interval in seconds'
        required: false
        default: '60'
      max_attempts:
        description: 'Maximum poll attempts'
        required: false
        default: '10'

jobs:
  # Test 1: Direct action usage (not through reusable workflow)
  test-direct-action:
    name: Test Direct Action Usage
    runs-on: ubuntu-latest
    outputs:
      pipeline_uuid: ${{ steps.trigger.outputs.triggered_pipeline_uuid }}
      pipeline_url: ${{ steps.trigger.outputs.pipeline_url }}
      pipeline_result: ${{ steps.wait.outputs.pipeline_result }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trigger custom pipeline
        id: trigger
        uses: ./.github/actions/trigger-custom-pipeline
        with:
          bitbucket_api_token: ${{ secrets.BITBUCKET_API_TOKEN }}
          bitbucket_repo: ${{ vars.BITBUCKET_REPO }}
          pipeline_name: ${{ inputs.pipeline_name }}
          branch_name: ${{ inputs.branch_name }}

      - name: Wait for pipeline (if enabled)
        id: wait
        if: inputs.wait_for_pipeline
        uses: ./.github/actions/wait-for-bitbucket-pipeline-by-uuid
        with:
          bitbucket_api_token: ${{ secrets.BITBUCKET_API_TOKEN }}
          bitbucket_repo: ${{ vars.BITBUCKET_REPO }}
          pipeline_uuid: ${{ steps.trigger.outputs.triggered_pipeline_uuid }}
          poll_interval: ${{ inputs.poll_interval }}
          max_attempts: ${{ inputs.max_attempts }}

      - name: Summary
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pipeline Name | ${{ inputs.pipeline_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ inputs.branch_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pipeline UUID | ${{ steps.trigger.outputs.triggered_pipeline_uuid }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pipeline URL | ${{ steps.trigger.outputs.pipeline_url }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.wait_for_pipeline }}" = "true" ]; then
            echo "| Pipeline Result | ${{ steps.wait.outputs.pipeline_result }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Pipeline Result | (not waiting) |" >> $GITHUB_STEP_SUMMARY
          fi

  # Test 2: Reusable workflow usage
  test-reusable-workflow:
    name: Test Reusable Workflow
    uses: ./.github/workflows/reusable-trigger-custom-pipeline.yml
    with:
      pipeline_name: ${{ inputs.pipeline_name }}
      branch_name: ${{ inputs.branch_name }}
      bitbucket_repo: ${{ vars.BITBUCKET_REPO }}
      wait_for_pipeline: ${{ inputs.wait_for_pipeline && 'true' || 'false' }}
      poll_interval: ${{ fromJSON(inputs.poll_interval) }}
      max_attempts: ${{ fromJSON(inputs.max_attempts) }}
    secrets:
      BITBUCKET_API_TOKEN: ${{ secrets.BITBUCKET_API_TOKEN }}

  # Summary job to compare both test approaches
  compare-results:
    name: Compare Test Results
    needs: [test-direct-action, test-reusable-workflow]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Compare outputs
        run: |
          echo "## Comparison Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Pipeline UUID | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Direct Action | ${{ needs.test-direct-action.outputs.pipeline_uuid }} | ${{ needs.test-direct-action.outputs.pipeline_result || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Reusable Workflow | ${{ needs.test-reusable-workflow.outputs.pipeline_uuid }} | ${{ needs.test-reusable-workflow.outputs.pipeline_result || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          
          echo ""
          echo "Direct Action URL: ${{ needs.test-direct-action.outputs.pipeline_url }}"
          echo "Reusable Workflow URL: ${{ needs.test-reusable-workflow.outputs.pipeline_url }}"

