name: Manual Deployment to Bitbucket

# Manual workflow to trigger deployments on Bitbucket
# Allows selecting staging or production environment
# Mirrors the appropriate release branch to Bitbucket and waits for deployment pipeline
on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment for deployment"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production
      branch:
        description: "Branch to deploy (defaults to release/{environment})"
        required: false
        default: ""
        type: string

permissions:
  contents: read

# One deployment per environment at a time
# This ensures deployments don't run in parallel for the same environment
concurrency:
  group: manual-deploy-${{ inputs.environment }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      TARGET_ENV: ${{ inputs.environment }}
      DEPLOY_BRANCH: ${{ inputs.branch != '' && inputs.branch || format('release/{0}', inputs.environment) }}
    
    steps:
      - name: Deployment job summary
        id: mirror
        run: |
          echo "ðŸš€ Manual Deployment - Echo Only Mode"
          echo "Triggered by: ${{ github.actor }} | Environment: ${TARGET_ENV}"
          echo "Branch: ${DEPLOY_BRANCH} | Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "Timestamp (UTC): $(date -u +"%Y-%m-%d %H:%M:%S")"
          if [ "${TARGET_ENV}" = "production" ]; then
            echo "âš ï¸  Production deployment requested (simulated)"
          else
            echo "â„¹ï¸  Staging deployment requested (simulated)"
          fi
          echo "âœ… Deployment pipeline completed successfully! (simulated)"
          # Set outputs for compatibility (if any downstream steps need them)
          echo "pipelines_configured=true" >> $GITHUB_OUTPUT
          echo "triggered_pipeline_uuid=simulated-uuid-12345" >> $GITHUB_OUTPUT
