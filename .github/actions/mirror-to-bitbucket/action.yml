name: 'Mirror to Bitbucket'
description: 'Mirrors the current branch to Bitbucket repository'

inputs:
  bitbucket_username:
    description: 'Bitbucket username or x-token-auth for API token/app token'
    required: true
  bitbucket_api_token:
    description: 'Bitbucket API token/app token with repo write permissions'
    required: true
  bitbucket_repo:
    description: 'Bitbucket repository path in owner/repo format'
    required: true
  bitbucket_user_email:
    description: 'Email for git config (can be a bot email)'
    required: true
  branch_name:
    description: 'Branch name to push or delete (defaults to GITHUB_REF_NAME if not provided)'
    required: false
    default: ''
  action_type:
    description: 'Action to perform: "push" to mirror the branch, or "delete" to delete the branch (defaults to push)'
    required: false
    default: 'push'
  force_trigger:
    description: 'If true, always push even if commit already exists (useful for retriggering flaky pipelines). Defaults to false for idempotent behavior.'
    required: false
    default: 'false'
  allow_branch_deletion:
    description: 'If "false", skip deleting branches on Bitbucket even when action_type is "delete". Defaults to "true" to preserve current behavior.'
    required: false
    default: 'true'

outputs:
  branch_pushed:
    description: 'The branch name that was pushed to Bitbucket'
    value: ${{ steps.mirror.outputs.branch_name }}
  push_occurred:
    description: 'Whether a push actually occurred (true) or was skipped due to idempotency (false)'
    value: ${{ steps.mirror.outputs.push_occurred }}
  triggered_pipeline_uuid:
    description: 'UUID of the pipeline that was triggered via API (if any)'
    value: ${{ steps.mirror.outputs.triggered_pipeline_uuid }}
  pipelines_configured:
    description: 'Whether bitbucket-pipelines.yml exists in the repository (true/false)'
    value: ${{ steps.mirror.outputs.pipelines_configured }}

runs:
  using: 'composite'
  steps:
    - name: Configure Git Identity
      shell: bash
      env:
        BITBUCKET_USER_EMAIL: ${{ inputs.bitbucket_user_email }}
      run: |
        git config user.name "GitHub Actions Bot - Mirror"
        git config user.email "haytham.labrini@eunasolutions.com"

    - name: Configure Bitbucket Remote
      shell: bash
      env:
        BITBUCKET_USERNAME: ${{ inputs.bitbucket_username }}
        BITBUCKET_API_TOKEN: ${{ inputs.bitbucket_api_token }}
        BITBUCKET_REPO: ${{ inputs.bitbucket_repo }}
      run: |
        # Create Base64 encoded credentials
        # Use -w 0 to disable line wrapping
        AUTH=$(echo -n "${BITBUCKET_USERNAME}:${BITBUCKET_API_TOKEN}" | base64 -w 0)
        
        # Configure http.extraHeader
        git config --local http.https://bitbucket.org/.extraHeader "Authorization: Basic ${AUTH}"
        
        # Add remote (remove if exists first to be safe)
        git remote remove bitbucket 2>/dev/null || true
        git remote add bitbucket "https://bitbucket.org/${BITBUCKET_REPO}.git"
        
        # Validate remote was added
        echo "Validating Bitbucket remote..."
        git remote get-url bitbucket

    - name: Delete Branch from Bitbucket
      if: inputs.action_type == 'delete'
      shell: bash
      env:
        BRANCH_NAME: ${{ inputs.branch_name }}
        ALLOW_BRANCH_DELETION: ${{ inputs.allow_branch_deletion }}
      run: |
        if [[ "$ALLOW_BRANCH_DELETION" == "false" ]]; then
          echo "â„¹ï¸ Skipping deletion of Bitbucket branch '${BRANCH_NAME}' because ALLOW_BRANCH_DELETION is false."
          echo "push_occurred=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        git fetch bitbucket --all
        
        # Check if branch exists
        if git ls-remote --heads bitbucket "${BRANCH_NAME}" | grep -q .; then
          # Branch exists, delete it
          git push bitbucket ":${BRANCH_NAME}"
          echo "âœ… Branch '${BRANCH_NAME}' deleted from Bitbucket"
          echo "push_occurred=true" >> $GITHUB_OUTPUT
        else
          # Branch does not exist
          echo "push_occurred=false" >> $GITHUB_OUTPUT
        fi

    - name: Mirror to Bitbucket
      if: inputs.action_type != 'delete'
      shell: bash
      env:
        BRANCH_NAME: ${{ inputs.branch_name }}
        FORCE_TRIGGER: ${{ inputs.force_trigger }}
      run: |
        # Fetch the branch from Bitbucket
        git fetch bitbucket "${BRANCH_NAME}" || echo "Branch ${BRANCH_NAME} not found on Bitbucket, will create it."
        
        CURRENT_COMMIT=$(git rev-parse HEAD)
        REMOTE_COMMIT=""
        
        if git ls-remote bitbucket "${BRANCH_NAME}" | grep -q .; then
          REMOTE_COMMIT=$(git ls-remote bitbucket "${BRANCH_NAME}" | awk '{print $1}')
        fi
        
        # Check if commits match
        if [[ -n "$REMOTE_COMMIT" && "$CURRENT_COMMIT" == "$REMOTE_COMMIT" && "$FORCE_TRIGGER" != "true" ]]; then
          echo "Commits match ($CURRENT_COMMIT). Checking if pipeline trigger is needed..."
          echo "push_occurred=true" >> $GITHUB_OUTPUT
          echo "trigger_pipeline=true" >> $GITHUB_OUTPUT
        else
          # Different commit or force trigger or new branch
          echo "Pushing branch '${BRANCH_NAME}' to Bitbucket..."
          
          # Capture output to check for specific errors
          if output=$(git push bitbucket "HEAD:${BRANCH_NAME}" 2>&1); then
            echo "$output"
            echo "âœ… Branch '${BRANCH_NAME}' pushed to Bitbucket"
            echo "push_occurred=true" >> $GITHUB_OUTPUT
            echo "trigger_pipeline=false" >> $GITHUB_OUTPUT
          else
             echo "$output"
             echo "âŒ Failed to push branch '${BRANCH_NAME}' to Bitbucket."
             
             if echo "$output" | grep -q "pre-receive hook declined"; then
               echo "::error::â›” PERMISSION DENIED: Bitbucket branch protection blocked the push."
               echo "ðŸ‘‰ SOLUTION: Go to Bitbucket Settings > Branching model > Branch permissions."
               echo "   Add your automation user to the '${BRANCH_NAME}' branch and allow 'Write' access."
               echo "   Ensure 'Prevent changes without a pull request' is disabled for this user."
             else
               echo "=== Bitbucket / GitHub Divergence Detected ==="
               echo "GitHub commit: ${CURRENT_COMMIT}"
               echo "Bitbucket commit: ${REMOTE_COMMIT}"
               echo "::error::Divergence or other error detected. See logs above."
             fi
             exit 1
          fi
        fi

    - name: Trigger Bitbucket Pipeline
      if: inputs.action_type != 'delete' && steps.mirror.outputs.trigger_pipeline == 'true'
      id: trigger
      shell: bash
      env:
        BITBUCKET_USERNAME: ${{ inputs.bitbucket_username }}
        BITBUCKET_API_TOKEN: ${{ inputs.bitbucket_api_token }}
        BITBUCKET_REPO: ${{ inputs.bitbucket_repo }}
        BRANCH_NAME: ${{ inputs.branch_name }}
        ACTION_TYPE: ${{ inputs.action_type }}
        COMMIT_SHA: ${{ github.sha }}
      run: node ${{ github.action_path }}/dist/index.js
