name: 'Mirror to Bitbucket'
description: 'Mirrors the current branch to Bitbucket repository'

inputs:
  bitbucket_username:
    description: 'Bitbucket username or x-token-auth for API token/app token'
    required: true
  bitbucket_api_token:
    description: 'Bitbucket API token/app token with repo write permissions'
    required: true
  bitbucket_repo:
    description: 'Bitbucket repository path in owner/repo format'
    required: true
  bitbucket_user_email:
    description: 'Email for git config (can be a bot email)'
    required: true
  branch_name:
    description: 'Branch name to push or delete (defaults to GITHUB_REF_NAME if not provided)'
    required: false
    default: ''
  action_type:
    description: 'Action to perform: "push" to mirror the branch, or "delete" to delete the branch (defaults to push)'
    required: false
    default: 'push'
  force_trigger:
    description: 'Deprecated: Force push is now always enabled. This input is kept for backward compatibility but has no effect.'
    required: false
    default: 'true'
  allow_branch_deletion:
    description: 'If "false", skip deleting branches on Bitbucket even when action_type is "delete". Defaults to "true" to preserve current behavior.'
    required: false
    default: 'true'

outputs:
  branch_pushed:
    description: 'The branch name that was pushed to Bitbucket'
    value: ${{ steps.mirror.outputs.branch_name }}
  push_occurred:
    description: 'Whether a push actually occurred (true) or was skipped due to idempotency (false)'
    value: ${{ steps.mirror.outputs.push_occurred }}
  triggered_pipeline_uuid:
    description: 'UUID of the pipeline that was triggered via API (if any)'
    value: ${{ steps.mirror.outputs.triggered_pipeline_uuid }}
  pipelines_configured:
    description: 'Whether bitbucket-pipelines.yml exists in the repository (true/false)'
    value: ${{ steps.mirror.outputs.pipelines_configured }}

runs:
  using: 'composite'
  steps:
    - name: Configure Git Identity
      shell: bash
      env:
        BITBUCKET_USER_EMAIL: ${{ inputs.bitbucket_user_email }}
      run: |
        git config user.name "GitHub Actions Bot - Mirror"
        git config user.email "haytham.labrini@eunasolutions.com"

    - name: Configure Bitbucket Remote
      shell: bash
      env:
        BITBUCKET_USERNAME: ${{ inputs.bitbucket_username }}
        BITBUCKET_API_TOKEN: ${{ inputs.bitbucket_api_token }}
        BITBUCKET_REPO: ${{ inputs.bitbucket_repo }}
      run: |
        # Disable credential helpers to prevent interactive prompts
        # This ensures Git uses our configured authentication instead of prompting
        git config --local credential.helper ""
        git config --global credential.helper ""
        
        # Disable GIT_ASKPASS to prevent interactive credential prompts
        # Setting it to empty string prevents Git from trying to prompt
        export GIT_ASKPASS=""
        export SSH_ASKPASS=""
        
        # Create Base64 encoded credentials for http.extraHeader (backup method)
        # Use -w 0 to disable line wrapping
        AUTH=$(echo -n "${BITBUCKET_USERNAME}:${BITBUCKET_API_TOKEN}" | base64 -w 0)
        
        # Configure http.extraHeader as a backup authentication method
        git config --local http.https://bitbucket.org/.extraHeader "Authorization: Basic ${AUTH}"
        
        # URL-encode username and token for embedding in remote URL
        # This is the most reliable method for automated environments
        # Remove any existing bitbucket remote first
        git remote remove bitbucket 2>/dev/null || true
        
        # Add remote with credentials embedded in URL (most reliable for automation)
        # Format: https://username:token@bitbucket.org/workspace/repo.git
        git remote add bitbucket "https://${BITBUCKET_USERNAME}:${BITBUCKET_API_TOKEN}@bitbucket.org/${BITBUCKET_REPO}.git"
        
        # Validate remote was added (URL will show credentials, which is expected)
        echo "Validating Bitbucket remote..."
        git remote get-url bitbucket

    - name: Delete Branch from Bitbucket
      if: inputs.action_type == 'delete'
      shell: bash
      env:
        BRANCH_NAME: ${{ inputs.branch_name }}
        ALLOW_BRANCH_DELETION: ${{ inputs.allow_branch_deletion }}
      run: |
        if [[ "$ALLOW_BRANCH_DELETION" == "false" ]]; then
          echo "â„¹ï¸ Skipping deletion of Bitbucket branch '${BRANCH_NAME}' because ALLOW_BRANCH_DELETION is false."
          echo "push_occurred=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        git fetch bitbucket --all
        
        # Check if branch exists
        if git ls-remote --heads bitbucket "${BRANCH_NAME}" | grep -q .; then
          # Branch exists, delete it
          git push bitbucket ":${BRANCH_NAME}"
          echo "âœ… Branch '${BRANCH_NAME}' deleted from Bitbucket"
          echo "push_occurred=true" >> $GITHUB_OUTPUT
        else
          # Branch does not exist
          echo "push_occurred=false" >> $GITHUB_OUTPUT
        fi

    - name: Mirror to Bitbucket
      if: inputs.action_type != 'delete'
      shell: bash
      env:
        BRANCH_NAME: ${{ inputs.branch_name }}
      run: |
        # Fetch the branch from Bitbucket to check if it exists
        git fetch bitbucket "${BRANCH_NAME}" || echo "Branch ${BRANCH_NAME} not found on Bitbucket, will create it."
        
        CURRENT_COMMIT=$(git rev-parse HEAD)
        REMOTE_COMMIT=""
        
        if git ls-remote bitbucket "${BRANCH_NAME}" | grep -q .; then
          REMOTE_COMMIT=$(git ls-remote bitbucket "${BRANCH_NAME}" | awk '{print $1}')
        fi
        
        # Always force push to ensure GitHub branch overwrites Bitbucket branch
        echo "Force pushing branch '${BRANCH_NAME}' to Bitbucket..."
        echo "GitHub commit: ${CURRENT_COMMIT}"
        if [[ -n "$REMOTE_COMMIT" ]]; then
          echo "Bitbucket commit: ${REMOTE_COMMIT}"
        else
          echo "Bitbucket branch does not exist yet, will be created"
        fi
        
        # Always use --force to overwrite any divergent history on Bitbucket
        if output=$(git push --force bitbucket "HEAD:${BRANCH_NAME}" 2>&1); then
          echo "$output"
          echo "âœ… Branch '${BRANCH_NAME}' force pushed to Bitbucket"
          echo "push_occurred=true" >> $GITHUB_OUTPUT
          
          # If commits matched before push, trigger pipeline via API instead
          if [[ -n "$REMOTE_COMMIT" && "$CURRENT_COMMIT" == "$REMOTE_COMMIT" ]]; then
            echo "Commits matched - pipeline will be triggered via API"
            echo "trigger_pipeline=true" >> $GITHUB_OUTPUT
          else
            echo "trigger_pipeline=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "$output"
          echo "âŒ Failed to force push branch '${BRANCH_NAME}' to Bitbucket."
          
          if echo "$output" | grep -q "pre-receive hook declined"; then
            echo "::error::â›” PERMISSION DENIED: Bitbucket branch protection blocked the push."
            echo "ðŸ‘‰ SOLUTION: Go to Bitbucket Settings > Branching model > Branch permissions."
            echo "   Add your automation user to the '${BRANCH_NAME}' branch and allow 'Write' access."
            echo "   Ensure 'Prevent changes without a pull request' is disabled for this user."
          else
            echo "=== Bitbucket Push Error ==="
            echo "GitHub commit: ${CURRENT_COMMIT}"
            if [[ -n "$REMOTE_COMMIT" ]]; then
              echo "Bitbucket commit: ${REMOTE_COMMIT}"
            fi
            echo "::error::Push failed. See logs above."
          fi
          exit 1
        fi

    - name: Trigger Bitbucket Pipeline
      if: inputs.action_type != 'delete' && steps.mirror.outputs.trigger_pipeline == 'true'
      id: trigger
      shell: bash
      env:
        BITBUCKET_USERNAME: ${{ inputs.bitbucket_username }}
        BITBUCKET_API_TOKEN: ${{ inputs.bitbucket_api_token }}
        BITBUCKET_REPO: ${{ inputs.bitbucket_repo }}
        BRANCH_NAME: ${{ inputs.branch_name }}
        ACTION_TYPE: ${{ inputs.action_type }}
        COMMIT_SHA: ${{ github.sha }}
      run: node ${{ github.action_path }}/dist/index.js
